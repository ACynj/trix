# 预训练结果分析与优化配置

## 当前预训练结果分析

### TRIXLatentMechanismPretrain 结果（当前配置）

| Epoch | FB15k237 MRR | WN18RR MRR | CoDExMedium MRR | 平均 MRR |
|-------|-------------|-----------|----------------|---------|
| 0 | 0.90422 | **0.690233** | **0.940161** | 0.84487 |
| 1 | **0.910392** | 0.67424 | 0.924765 | 0.83647 |
| 2 | 0.889563 | 0.671414 | 0.898679 | 0.81989 |
| 3 | 0.903274 | 0.683401 | 0.917827 | 0.83483 |
| 4 | 0.885981 | 0.680605 | 0.910929 | 0.82584 |
| 5 | 0.873465 | 0.6721 | 0.884072 | 0.80988 |
| 6 | 0.877184 | 0.669033 | 0.891268 | 0.81249 |

**最佳结果**：Epoch 0-1

### 基线 TRIX 结果对比

| Epoch | FB15k237 MRR | WN18RR MRR | CoDExMedium MRR | 平均 MRR |
|-------|-------------|-----------|----------------|---------|
| 0 | 0.903309 | **0.733298** | **0.924856** | 0.85382 |
| 1 | 0.896041 | 0.687555 | 0.906894 | 0.83016 |
| 4 | **0.905744** | 0.709549 | 0.889341 | 0.83488 |

**最佳结果**：Epoch 0-4

## 问题诊断

### 1. WN18RR 表现较差
- **当前**: 0.690233 (Epoch 0) vs 基线 0.733298
- **可能原因**:
  - KL 权重 `beta=1e-3` 可能过大，过度约束了机制 z
  - WN18RR 数据集特性：关系类型较少，可能需要更灵活的机制建模

### 2. 过拟合问题
- Epoch 2 之后性能开始下降
- 损失持续降低但验证指标下降
- **可能原因**:
  - 缺乏学习率调度
  - 缺乏权重衰减
  - 训练轮次过多但缺乏正则化

### 3. 训练不稳定
- 不同 epoch 之间波动较大
- **可能原因**:
  - 学习率可能偏高
  - KL 权重需要调整

## 优化策略

### 策略 1：降低 KL 权重（推荐）

**配置文件**: `pretrain_relation_mech_pretrain_optimized.yaml`

**关键改动**:
- `beta: 5.0e-4` (从 1e-3 降低)
- `weight_decay: 1.0e-5` (添加权重衰减)
- `num_epoch: 15` (增加轮次但配合调度器)

**预期效果**:
- WN18RR 性能提升（机制 z 更灵活）
- 减少过拟合
- 更稳定的训练

### 策略 2：进一步降低 KL 权重（激进）

**配置文件**: `pretrain_relation_mech_pretrain_v2.yaml`

**关键改动**:
- `beta: 1.0e-4` (进一步降低)
- `lr: 3.0e-4` (降低初始学习率)
- `num_epoch: 20` (更多轮次)

**预期效果**:
- 机制 z 更灵活，可能提升 WN18RR
- 更稳定的训练过程
- 需要更多轮次收敛

## 推荐配置对比

| 配置项 | 当前配置 | 优化配置1 | 优化配置2 | 最佳配置 |
|--------|---------|----------|----------|----------|
| **配置文件** | pretrain_relation_mech_pretrain.yaml | pretrain_relation_mech_pretrain_optimized.yaml | pretrain_relation_mech_pretrain_v2.yaml | pretrain_relation_mech_pretrain_best.yaml |
| beta | 1.0e-3 | **5.0e-4** | **1.0e-4** | **2.5e-4** |
| lr | 5.0e-4 | 5.0e-4 | **3.0e-4** | **4.0e-4** |
| weight_decay | 无 | **1.0e-5** | **1.0e-5** | **1.0e-5** |
| num_epoch | 10 | **15** | **20** | **15** |
| **预期 WN18RR** | 0.69 | 0.71-0.72 | 0.72-0.73 | **0.72-0.73** |
| **预期稳定性** | 中 | 高 | 高 | **最高** |
| **推荐度** | - | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |

## 使用建议

### 🎯 推荐：最佳配置（balanced）
```bash
python src/pretrain_relation.py \
    -c ./config/pretrain_relation_mech_pretrain_best.yaml \
    --gpus [0]
```

**特点**：
- beta=2.5e-4：平衡灵活性和正则化
- lr=4.0e-4：适中的学习率
- 预期在三个数据集上都有良好表现

### 备选方案1：保守优化
```bash
python src/pretrain_relation.py \
    -c ./config/pretrain_relation_mech_pretrain_optimized.yaml \
    --gpus [0]
```

**特点**：
- beta=5.0e-4：较保守的降低
- 适合第一次尝试优化

### 备选方案2：激进优化
```bash
python src/pretrain_relation.py \
    -c ./config/pretrain_relation_mech_pretrain_v2.yaml \
    --gpus [0]
```

**特点**：
- beta=1.0e-4：最小 KL 约束
- lr=3.0e-4：较低学习率
- 需要更多轮次收敛

## 预期改进

基于分析，预期改进：

1. **WN18RR MRR**: 从 0.69 → **0.71-0.73** (+2-4%)
2. **平均 MRR**: 从 0.84 → **0.85-0.86** (+1-2%)
3. **训练稳定性**: 减少过拟合，更平滑的收敛曲线
4. **整体性能**: 在三个数据集上更均衡的表现

## 监控指标

训练时重点关注：
- **WN18RR MRR**: 目标 > 0.72
- **FB15k237 MRR**: 保持 > 0.90
- **CoDExMedium MRR**: 保持 > 0.92
- **Loss 曲线**: 应该平滑下降，验证指标不应在后期下降

